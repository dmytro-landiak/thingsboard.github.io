* TOC
{:toc}

### Authentication Providers

TBMQ offers two authentication methods: [Basic](#basic-authentication) and [TLS](#tls-authentication). 
If neither method is enabled, clients can connect to the broker and publish/subscribe to topics without any restrictions.
**Note:** all the clients will be connected as [Device](/docs/mqtt-broker/user-guide/mqtt-client-type/#device-client) client type.
Creating [Application](/docs/mqtt-broker/user-guide/mqtt-client-type/#application-client) clients will not be possible.

#### X.509 Certificate Chain Authentication

To enable TLS authentication, you must first [enable the TLS listener](/docs/mqtt-broker/security/#tls-listener) so that the client's certificate chain is involved in the authentication process.

After enabling the TLS listener, you need to do the following to enable TLS authentication:

1. Set the `SECURITY_MQTT_SSL_ENABLED` environment variable to `true`.
2. Create MQTT client credentials of type `X.509 Certificate Chain` using either the [Web UI guide](/docs/mqtt-broker/user-guide/ui/mqtt-client-credentials/) or the [REST API guide](/docs/mqtt-broker/mqtt-client-credentials-management/).
3. Once the credentials are created, the `credentialsId` field is auto-generated. See below for more information.

##### Credentials Matching

The "X.509 Certificate Chain" credentials have a **"Use certificate CN regex"** option that controls how credentials are matched.

* When "Use certificate CN regex" is disabled:
the "Certificate common name (CN)" must **exactly** match the CN of the client's certificate or, if present, one of the parent's certificates in the chain. 
Authentication will fail if none of the certificates have an exactly matching CN.

* "Use certificate CN regex" is enabled:
the "Certificate common name (CN) matcher regex" must match the CN of the client's certificate or, if present, one of the parent's certificates in the chain. 
Authentication will fail if no certificate in the chain matches the regex.

##### Credentials ID

The generation of `credentialsId` is done as follows:

- credentialsId = `ssl|$CERTIFICATE_COMMON_NAME`;
- credentialsId = `ssl|$CERTIFICATE_COMMON_NAME_REGEX`.

Where `$CERTIFICATE_COMMON_NAME` is the common name of the certificate from the chain, `$CERTIFICATE_COMMON_NAME_REGEX` is a regex-based string
that should be matched with the certificate's CN from the chain.

{% include images-gallery.html imageCollection="security-authentication-tls" %}

### Authorization

After the user has been authenticated, it is possible to restrict the client's access to topics they can publish or subscribe to for both TLS and Basic authentications.

To provide flexible control over authorization rules, TBMQ uses regular expressions. 

For example, to **allow clients to publish or subscribe to all topics** that begin with **city/**, an authorization rule should be created with the value **city/.***.

#### TLS

For TLS type, authorization is configured using the **authRulesMapping** field of the corresponding MQTT Client Credentials.
Here is a model of the credentials value:

```
{
    "certCnPattern": $certCnPattern,
    "certCnIsRegex": $certCnIsRegex,
    "authRulesMapping": $authRulesMapping
}
```
{: .copy-code}

Where:
- $certCnPattern - the pattern for the common name that should be present in the certificate chain.
- $certCnIsRegex - option to control whether the common name (CN) pattern is treated as a regular expression (regex) for matching.
- $authRulesMapping - the mapping used to configure the access restrictions for different keywords.
  For example,
  ```
  {
      "example_1": {
	      "pubAuthRulePatterns": ["example_pub_topic/.*"],
	      "subAuthRulePatterns": ["example_sub_topic/.*"]
	  },
	  "example_2": {
          "pubAuthRulePatterns": [".*"],
		  "subAuthRulePatterns": [".*"]
      }
  }
  ```
  {: .copy-code}

This allows clients to connect with a certificate containing **example_1** in its CN to publish only to topics that start with **example_pub_topic/** and 
subscribe to topics that start with **example_sub_topic/**. Clients with a certificate containing **example_2** are allowed to publish and subscribe to any topic.

**Note:** if either **pubAuthRulePatterns** or **subAuthRulePatterns** is set to `null` or an empty list (`[]`), the client will not be able to publish to or subscribe to any topics.

{% include images-gallery.html imageCollection="security-authorization-tls" %}

## Next steps

{% assign currentGuide = "SecurityGuide" %}{% include templates/mqtt-broker-guides-banner.md %}
