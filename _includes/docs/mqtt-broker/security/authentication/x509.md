* TOC
{:toc}

**MQTT X.509 Certificate Chain Authentication** is a secure and widely used method for verifying client identity using digital certificates. 
It replaces traditional credentials like usernames and passwords with **TLS certificates**, providing a more robust and scalable approach to authenticationâ€”particularly in systems where device identity and data integrity are critical.

### X.509 authentication overview

X.509 Certificate Chain Authentication uses client-side TLS certificates to authenticate MQTT clients. 
During the TLS handshake, the client presents its certificate, which the broker validates against a trusted certificate authority (CA) or a configured certificate chain.
This method provides strong security by relying on public key infrastructure (PKI) and is well-suited for environments where devices can securely store and manage private keys and certificates. 
It eliminates the need for passwords and reduces the risk of credential leakage.

### Configure provider

{% include docs/mqtt-broker/user-guide/ui/authentication-provider-control.md %}

#### Skip certificate validity check for client certificates

The **Skip certificate validity check for client certificates** parameter in X.509 Certificate Chain Authentication controls whether the broker verifies the validity period of the client's certificate during authentication.
* When `enabled`, TBMQ skips the validation of the Not Before and Not After dates in the certificate, meaning expired or not-yet-valid certificates will still be accepted.
* When `disabled`, the broker enforces the standard validity checks, and authentication will fail if the certificate is expired or not yet valid.

This setting can be useful in testing or specific trust-controlled environments, but it is not recommended for production deployments, as it weakens the certificate-based security model.

#### Authentication

TBMQ supports flexible mechanisms for matching client credentials when using X.509 Certificate Chain authentication. 
This process determines how the broker identifies and validates a certificate presented by a client. 
Depending on the configuration, matching can be performed using either exact Common Name (CN) values or pattern-based regular expressions. 
These settings also affect how credential identifiers are generated and used during authentication.

##### Credentials matching

The "X.509 Certificate Chain" credentials have a **"Use certificate CN regex"** option that controls how credentials are matched.

* When "Use certificate CN regex" is disabled:
the "Certificate common name (CN)" must **exactly** match the CN of the client's certificate or, if present, one of the parent's certificates in the chain. 
Authentication will fail if none of the certificates have an exactly matching CN.

* "Use certificate CN regex" is enabled:
the "Certificate common name (CN) matcher regex" must match the CN of the client's certificate or, if present, one of the parent's certificates in the chain. 
Authentication will fail if no certificate in the chain matches the regex.

##### Credentials ID

The generation of `credentialsId` is done as follows:

- credentialsId = `ssl|$CERTIFICATE_COMMON_NAME`;
- credentialsId = `ssl|$CERTIFICATE_COMMON_NAME_REGEX`.

Where `$CERTIFICATE_COMMON_NAME` is the common name of the certificate from the chain, `$CERTIFICATE_COMMON_NAME_REGEX` is a regex-based string
that should be matched with the certificate's CN from the chain.

{% include images-gallery.html imageCollection="security-authentication-tls" %}

#### Authorization

After the user has been authenticated, it is possible to restrict the client's access to topics they can publish or subscribe to.

To provide flexible control over authorization rules, TBMQ uses regular expressions. 

For example, to **allow clients to publish or subscribe to all topics** that begin with **city/**, an authorization rule should be created with the value **city/.***.

For TLS type, authorization is configured using the **authRulesMapping** field of the corresponding MQTT Client Credentials.
Here is a model of the credentials value:

```
{
    "certCnPattern": $certCnPattern,
    "certCnIsRegex": $certCnIsRegex,
    "authRulesMapping": $authRulesMapping
}
```
{: .copy-code}

Where:
- $certCnPattern - the pattern for the common name that should be present in the certificate chain.
- $certCnIsRegex - option to control whether the common name (CN) pattern is treated as a regular expression (regex) for matching.
- $authRulesMapping - the mapping used to configure the access restrictions for different keywords.
  For example,
  ```
  {
      "example_1": {
	      "pubAuthRulePatterns": ["example_pub_topic/.*"],
	      "subAuthRulePatterns": ["example_sub_topic/.*"]
	  },
	  "example_2": {
          "pubAuthRulePatterns": [".*"],
		  "subAuthRulePatterns": [".*"]
      }
  }
  ```
  {: .copy-code}

This allows clients to connect with a certificate containing **example_1** in its CN to publish only to topics that start with **example_pub_topic/** and 
subscribe to topics that start with **example_sub_topic/**. Clients with a certificate containing **example_2** are allowed to publish and subscribe to any topic.

**Note:** if either **pubAuthRulePatterns** or **subAuthRulePatterns** is set to `null` or an empty list (`[]`), the client will not be able to publish to or subscribe to any topics.

{% include images-gallery.html imageCollection="security-authorization-tls" %}

## Next steps

{% assign currentGuide = "SecurityGuide" %}{% include templates/mqtt-broker-guides-banner.md %}
